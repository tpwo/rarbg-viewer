{% extends 'base.html' %}

{% block title %}RareTide Search{% endblock %}

{% block content %}
<div class="main-content">
    <div class="search-card">
        <form id="search-form" onsubmit="return false;">
            <input type="text" class="search-box" id="search-box" autofocus placeholder="Search for names...">
            <select id="category-select">
                <option value="">All Categories</option>
                <option value="Movies">Movies</option>
                <option value="TV">TV</option>
                <option value="Games">Games</option>
                <option value="Music">Music</option>
                <option value="Books">Books</option>
                <option value="Software">Software</option>
                <option value="Adult">Adult</option>
            </select>
            <button type="button" id="btn-search" class="search-btn">
                <span style="display:inline-block;vertical-align:middle;">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle;">
                        <circle cx="9" cy="9" r="7" stroke="currentColor" stroke-width="2"/>
                        <line x1="14.4142" y1="14" x2="18" y2="17.5858" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </span>
                Search
            </button>
        </form>
    </div>
    <div id="results" style="display:none;"></div>
    <div id="pagination" style="display:none;"></div>
</div>
{% endblock %}

{% block head %}
<script src="/static/script.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Extract query and page from URL
    const pathParts = window.location.pathname.split('/').filter(Boolean);
    const query = decodeURIComponent(pathParts[1] || '');
    const page = parseInt(pathParts[2] || '1', 10);
    const resultsContainer = document.getElementById('results');
    const paginationContainer = document.getElementById('pagination');
    const perPage = 20;

    // Extract category from URL (query param)
    function getCategoryFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('category') || '';
    }


    function showSpinner() {
        resultsContainer.innerHTML = '<div class="spinner"></div>';
        resultsContainer.style.display = '';
    }

    function fetchResults() {
        if (!query) return;
        showSpinner();
        const category = getCategoryFromUrl();
        let url = `/results?search_query=${encodeURIComponent(query)}&page=${page}&per_page=${perPage}`;
        if (category) url += `&category=${encodeURIComponent(category)}`;
        fetch(url)
            .then(res => res.json())
            .then(data => {
                renderResults(data.result || []);
                renderPagination(data.total_count || 0);
            });
    }

    function humanReadableSize(size) {
        if (typeof size !== 'number' || isNaN(size) || size === 0) return 'N/A';
        if (size < 1000) return size + ' B';
        const units = ['KB', 'MB', 'GB', 'TB'];
        let unit = -1;
        do {
            size = size / 1000;
            unit++;
        } while (size >= 1000 && unit < units.length - 1);
        return size.toFixed(2) + ' ' + units[unit];
    }

    function renderResults(results) {
        resultsContainer.style.display = '';
        if (results.length === 0) {
            resultsContainer.innerHTML = '<p>No results found.</p>';
            return;
        }
        // r[0]=title, r[1]=category, r[2]=date, r[3]=size (bytes)
        resultsContainer.innerHTML = '<ul class="results-list">' + results.map(r => `
            <li class="result-card">
                <div class="result-title">${escapeHtml(r[0])}</div>
                <div class="result-meta">
                    <span class="badge">${escapeHtml(r[1])}</span>
                    <span>${escapeHtml(r[2])}</span>
                    <span>${humanReadableSize(Number(r[3]))}</span>
                </div>
            </li>
        `).join('') + '</ul>';
    }

    // Escape HTML utility
    function escapeHtml(text) {
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function renderPagination(totalCount) {
        paginationContainer.style.display = '';
        const totalPages = Math.ceil(totalCount / perPage);
        let html = '';
        if (page > 1) {
            html += `<a href="/search/${encodeURIComponent(query)}/${page-1}/">Previous</a> `;
        }
        html += `Page ${page} of ${totalPages}`;
        if (page < totalPages) {
            html += ` <a href="/search/${encodeURIComponent(query)}/${page+1}/">Next</a>`;
        }
        paginationContainer.innerHTML = html;
    }

    // Prepopulate search box
    setTimeout(function() {
        const searchBox = document.getElementById('search-box');
        if (searchBox) searchBox.value = query;
        // Preselect category in dropdown
        const category = getCategoryFromUrl();
        const catSelect = document.getElementById('category-select');
        if (catSelect && category) catSelect.value = category;
    }, 0);

    // Auto-search on category change
    setTimeout(function() {
        const catSelect = document.getElementById('category-select');
        if (catSelect) {
            catSelect.addEventListener('change', function() {
                // Only redirect if search box is not empty
                const searchBox = document.getElementById('search-box');
                const queryVal = searchBox ? searchBox.value : '';
                if (!queryVal) return;
                let url = `/search/${encodeURIComponent(queryVal)}/1/`;
                if (catSelect.value) url += `?category=${encodeURIComponent(catSelect.value)}`;
                window.location.href = url;
            });
        }
    }, 0);

    // Only fetch results if query is present
    if (query) {
        resultsContainer.style.display = '';
        paginationContainer.style.display = '';
        fetchResults();
    }
});
</script>
{% endblock %}
